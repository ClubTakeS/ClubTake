<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubTake - メンバー専用ページ</title>

    <!-- ▼▼▼▼▼▼▼▼▼▼ 変更点（Tailwindのエラー修正） ▼▼▼▼▼▼▼▼▼▼ -->
    <!-- 
      Tailwind の本体 CDN スクリプトを「先」に読み込み、
      その「後」で tailwind.config を設定します。
      (順序を再度入れ替えました)
    -->
    
    <!-- 1. Tailwind CSS を読み込みます (これが "tailwind" オブジェクトを定義します) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Tailwind CSSのカスタム設定 (読み込んだ "tailwind" オブジェクトを使います) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'serif-jp': ['"Noto Serif JP"', 'serif']
                    },
                    colors: {
                        // ワイヤーフレームで指定したアクセント色（ゴールド）
                        'brand-gold': '#C0A16B',
                        'brand-gold-light': '#DBC18B', // 少し明るく
                        'brand-gold-dark': '#A0814B'  // 少し暗く
                    }
                }
            }
        }
    </script>
    <!-- ▲▲▲▲▲▲▲▲▲▲ 変更点 ▲▲▲▲▲▲▲▲▲▲ -->
    
    <!-- Google Fonts（明朝体とサンセリフ体）を読み込みます -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- CSSファイルを読み込みます -->
    <link rel="stylesheet" href="css/style.css">

    <!-- (設定スクリプトは上記に移動しました) -->

    <style>
        /* 編集フォームの input スタイル */
        .profile-input {
            @apply w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-brand-gold;
        }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans">

    <!-- 共通ヘッダー -->
    <header class="sticky top-0 z-50 w-full bg-black bg-opacity-80 backdrop-blur-sm shadow-lg border-b border-gray-800">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- ロゴ -->
            <div class="text-2xl font-serif-jp font-bold">
                <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                    ClubTake [Members]
                </span>
            </div>
            <!-- ナビゲーション（PC用） -->
            <div class="flex space-x-4 md:space-x-8 text-sm tracking-wide">
                <a href="index.html" class="text-gray-300 hover:text-brand-gold transition-colors duration-300">Home</a>
                <!-- ▼▼▼▼▼▼▼▼▼▼ 変更点（ログアウトボタン） ▼▼▼▼▼▼▼▼▼▼ -->
                <a href="#" id="logout-button" class="text-gray-300 hover:text-brand-gold transition-colors duration-300">ログアウト</a>
                <!-- ▲▲▲▲▲▲▲▲▲▲ 変更点 ▲▲▲▲▲▲▲▲▲▲ -->
            </div>
        </nav>
    </header>

    <!-- メインコンテンツ -->
    <main>
        
        <!-- 1. メンバーズページ: セクション1 (ファーストビュー) -->
        <section class="h-[70vh] min-h-[500px] relative flex items-center justify-center text-center text-white overflow-hidden">
            
            <!-- 背景画像（ラウンジや書斎のイメージ） -->
            <div class="absolute inset-0 bg-cover bg-center z-0" 
                 style="background-image: url('https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&auto=format&fit=crop&w=1740&q=80');">
                 <!-- (写真提供: GIO SUM on Unsplash) -->
            </div>
            
            <!-- 背景のオーバーレイ（黒い透かし） -->
            <div class="absolute inset-0 bg-black opacity-60 z-10"></div>
            
            <!-- 中央配置テキスト（ウェルカムメッセージ） -->
            <div class="relative z-20 p-8 space-y-4">
                <h1 id="welcome-message" class="text-4xl md:text-6xl font-serif-jp font-bold hero-text-1" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                    <!-- ここに「〇〇様、ようこそ」と表示されます -->
                    読み込み中...
                </h1>
                
                <!-- エラーメッセージ（ログインしていない時など） -->
                <p id="page-error-message" class="text-red-400 text-lg hero-text-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.7);"></p>
            </div>
        </section>


        <section class="py-20 md:py-24">
            
            <div class="container mx-auto px-6">

                <!-- ▼▼▼▼▼▼▼▼▼▼ 変更点（プロフィールカードと会員一覧のコンテナ） ▼▼▼▼▼▼▼▼▼▼ -->
                <div id="member-dashboard" class="grid grid-cols-1 lg:grid-cols-3 gap-12 fade-in" style="display: none;">
                    
                    <!-- --- 左側：個人情報カード --- -->
                    <div class="lg:col-span-1 space-y-12">
                        <div class="bg-black border border-gray-800 rounded-lg shadow-xl overflow-hidden p-8">
                            <h2 class="text-2xl font-serif-jp text-center mb-8 border-b border-gray-700 pb-4 text-brand-gold-light">
                                マイプロフィール
                            </h2>
                            
                            <!-- プロフィール表示モード -->
                            <div id="profile-view" class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-500">NICKNAME</label>
                                    <p id="view-nickname" class="text-lg text-gray-200">-</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">NAME</label>
                                    <p id="view-name" class="text-lg text-gray-200">-</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">MAIL</label>
                                    <p id="view-email" class="text-lg text-gray-200">-</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">BIRTH DAY</label>
                                    <p id="view-birthday" class="text-lg text-gray-200">-</p>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">MEMBER SINCE</label>
                                    <p id="view-since" class="text-lg text-gray-200">-</p>
                                </div>
                                <button id="edit-profile-button" class="w-full mt-6 py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-medium transition-colors">
                                    プロフィールを編集
                                </button>
                            </div>
                            
                            <!-- プロフィール編集モード (初期状態は非表示) -->
                            <form id="profile-edit" class="space-y-4" style="display: none;">
                                <div>
                                    <label for="edit-nickname" class="text-sm text-gray-500">NICKNAME</label>
                                    <input type="text" id="edit-nickname" class="profile-input">
                                </div>
                                <div>
                                    <label for="edit-name" class="text-sm text-gray-500">NAME</label>
                                    <input type="text" id="edit-name" class="profile-input">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-500">MAIL (変更不可)</label>
                                    <p id="edit-email" class="text-lg text-gray-400">-</p>
                                </div>
                                <div>
                                    <label for="edit-birthday" class="text-sm text-gray-500">BIRTH DAY (例: 1月1日)</label>
                                    <input type="text" id="edit-birthday" class="profile-input" placeholder="1月1日">
                                </div>
                                <div class="h-5">
                                    <p id="profile-message" class="text-sm text-green-400 text-center"></p>
                                </div>
                                <div class="flex gap-4 mt-6">
                                    <button id="cancel-edit-button" type="button" class="w-1/2 py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white font-medium transition-colors">
                                        キャンセル
                                    </button>
                                    <button id="save-profile-button" type="button" class="w-1/2 py-2 px-4 bg-brand-gold hover:bg-brand-gold-light rounded-lg text-black font-medium transition-colors">
                                        保存
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- --- メンバー専用お知らせ --- -->
                        <div id="announcements-section" class="bg-black border border-gray-800 rounded-lg shadow-xl overflow-hidden p-8 md:p-12">
                            <h2 class="text-2xl font-serif-jp text-center mb-8 border-b border-gray-700 pb-4">
                                メンバー専用お知らせ
                            </h2>
                            <!-- 読み込み中メッセージ -->
                            <div id="announcements-loading" class="text-center text-gray-400">
                                読み込み中...
                            </div>
                            <!-- お知らせ一覧が挿入されるコンテナ -->
                            <div id="announcements-list" class="space-y-8">
                                <!-- JSによって記事が挿入されます -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- --- 右側：会員一覧 --- -->
                    <div class="lg:col-span-2">
                        <div class="bg-black border border-gray-800 rounded-lg shadow-xl overflow-hidden p-8 md:p-12">
                            <h2 class="text-2xl font-serif-jp text-center mb-8 border-b border-gray-700 pb-4 text-brand-gold-light">
                                現メンバー一覧
                            </h2>
                            <!-- 読み込み中メッセージ -->
                            <div id="member-list-loading" class="text-center text-gray-400">
                                メンバーリストを読み込んでいます...
                            </div>
                            <!-- 会員一覧が挿入されるコンテナ -->
                            <div id="member-list-container" class="space-y-4">
                                <!-- JSによってメンバーが挿入されます -->
                                <!-- (表示例)
                                <div class="flex items-center justify-between p-4 bg-gray-900 border border-gray-700 rounded-lg">
                                    <p class="text-lg text-brand-gold-light">Taro_Yamada (Nickname)</p>
                                    <p class="text-sm text-gray-500">MEMBER SINCE: 2025年11月30日</p>
                                </div>
                                -->
                            </div>
                        </div>
                    </div>

                </div>
                <!-- ▲▲▲▲▲▲▲▲▲▲ 変更点 ▲▲▲▲▲▲▲▲▲▲ -->
                
            </div>
        </section>
    </main>

    <!-- 共通フッター（変更なし） -->
    <footer class="py-16 bg-black border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-400">
            <p class="text-xs text-gray-500 mt-8">
                &copy; 2025 ClubTake. All Rights Reserved. [Members Only]
            </D>
        </div>
    </footer>

    <!-- アニメーション用JSの読み込み（変更なし） -->
    <script src="js/main.js" defer></script>

    <!-- Firebaseの機能を読み込む -->
    <script type="module">
        // Firebaseの基本的な機能（App）を読み込みます
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebaseのログイン機能（Auth）を読み込みます
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // ▼▼▼▼▼▼▼▼▼▼ 変更点（Realtime DBのインポート） ▼▼▼▼▼▼▼▼▼▼
        // get, update, query, orderByChild を追加
        import { getDatabase, ref, query, orderByChild, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        // ▲▲▲▲▲▲▲▲▲▲ 変更点 ▲▲▲▲▲▲▲▲▲▲

        // あなたの「本物の」設定情報を貼り付けます
        const firebaseConfig = {
          apiKey: "AIzaSyDgpAbNmhRGgxiJusSqo1mG1wJbX4TS0uI",
          authDomain: "clubtake-257af.firebaseapp.com",
          projectId: "clubtake-257af",
          storageBucket: "clubtake-257af.firebasestorage.app",
          messagingSenderId: "871043706318",
          appId: "1:871043706318:web:19e8cfb02823003e518f9f",
          measurementId: "G-NVXMV89KHP"
        };
        
        // Realtime Database の URL を config に追加します
        firebaseConfig.databaseURL = "https://clubtake-257af-default-rtdb.firebaseio.com/";

        let app, auth, db;
        let currentUserId = null; // ログイン中のユーザーID
        
        // UI要素
        const welcomeMessage = document.getElementById('welcome-message');
        const pageErrorMessage = document.getElementById('page-error-message');
        const dashboard = document.getElementById('member-dashboard');
        
        // XSS対策
        const escapeHTML = (str) => {
            if (typeof str !== 'string' || !str) return '';
            return str.replace(/[&<>"']/g, (match) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[match]));
        };

        (async () => {
            try {
                // Firebaseを初期化します
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);

                // ログイン状態をブラウザに保存するように設定
                await setPersistence(auth, browserLocalPersistence);

                // ログイン状態を監視します
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // --- 認証OK ---
                        currentUserId = user.uid;
                        
                        // DBからユーザーの役割（isAdminやニックネーム）を取得
                        const userRoleRef = ref(db, `user_roles/${currentUserId}`);
                        const snapshot = await get(userRoleRef);

                        if (snapshot.exists()) {
                            // --- 承認済みメンバー ---
                            const userData = snapshot.val();
                            
                            // 1. ウェルカムメッセージを表示
                            const displayName = userData.nickname || userData.email;
                            welcomeMessage.textContent = `${escapeHTML(displayName)} 様、ようこそ。`;
                            
                            // 2. ダッシュボードを表示
                            dashboard.style.display = 'grid';
                            
                            // 3. プロフィールカードを読み込み
                            loadProfileCard(user, userData);
                            setupProfileEditing(user, userData);
                            
                            // 4. メンバー専用お知らせを読み込み
                            loadMemberAnnouncements();
                            
                            // 5. 現メンバー一覧を読み込み
                            loadAllMembers();

                        } else {
                            // --- 承認待ち or 拒否されたユーザー ---
                            console.log("Authには存在するが、user_roles にデータがありません。");
                            pageErrorMessage.textContent = 'アカウントは承認待ち、またはアクセスが許可されていません。';
                            // 3秒後にログインページにリダイレクト
                            setTimeout(() => {
                                const repoPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                                window.location.href = window.location.origin + repoPath + '/login.html';
                            }, 3000);
                        }
                    } else {
                        // --- ログインしていない ---
                        pageErrorMessage.textContent = 'アクセス権限がありません。ログインしてください。';
                        // 3秒後にログインページにリダイレクト
                        setTimeout(() => {
                            const repoPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                            window.location.href = window.location.origin + repoPath + '/login.html';
                        }, 3000);
                    }
                });
                
                // ログアウトボタンを有効化
                setupLogoutButton();

            } catch (error) {
                console.error("Firebase initialization error:", error);
                pageErrorMessage.textContent = 'システムの初期化に失敗しました。';
            }
        })();

        // ▼▼▼▼▼▼▼▼▼▼ 新機能：プロフィールカード ▼▼▼▼▼▼▼▼▼▼

        /**
         * プロフィールカードに情報を表示する
         */
        function loadProfileCard(user, userData) {
            document.getElementById('view-nickname').textContent = escapeHTML(userData.nickname) || '(未設定)';
            document.getElementById('view-name').textContent = escapeHTML(userData.name) || '(未設定)';
            document.getElementById('view-email').textContent = escapeHTML(user.email); // Authから
            document.getElementById('view-birthday').textContent = escapeHTML(userData.birthday) || '(未設定)';
            
            if (userData.createdAt) {
                const date = new Date(userData.createdAt);
                document.getElementById('view-since').textContent = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            } else {
                document.getElementById('view-since').textContent = '-';
            }
        }

        /**
         * プロフィール編集のイベントリスナーを設定する
         */
        function setupProfileEditing(user, userData) {
            const viewMode = document.getElementById('profile-view');
            const editMode = document.getElementById('profile-edit');
            const messageEl = document.getElementById('profile-message');

            // 編集フォームの初期値
            const nicknameInput = document.getElementById('edit-nickname');
            const nameInput = document.getElementById('edit-name');
            const birthdayInput = document.getElementById('edit-birthday');
            
            // 「編集」ボタン
            document.getElementById('edit-profile-button').addEventListener('click', () => {
                nicknameInput.value = userData.nickname || '';
                nameInput.value = userData.name || '';
                birthdayInput.value = userData.birthday || '';
                document.getElementById('edit-email').textContent = user.email;
                messageEl.textContent = '';
                
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
            });
            
            // 「キャンセル」ボタン
            document.getElementById('cancel-edit-button').addEventListener('click', () => {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
            });
            
            // 「保存」ボタン
            document.getElementById('save-profile-button').addEventListener('click', async () => {
                messageEl.textContent = '保存中...';
                messageEl.className = 'text-sm text-yellow-400 text-center';
                
                const updates = {
                    nickname: nicknameInput.value,
                    name: nameInput.value,
                    birthday: birthdayInput.value
                };

                try {
                    // データベースの「自分」の場所を更新
                    const userRoleRef = ref(db, `user_roles/${currentUserId}`);
                    await update(userRoleRef, updates);
                    
                    messageEl.textContent = '保存しました！';
                    messageEl.className = 'text-sm text-green-400 text-center';
                    
                    // データを再読み込みして表示に反映
                    const snapshot = await get(userRoleRef);
                    userData = snapshot.val(); // グローバル変数を更新
                    loadProfileCard(user, userData); // 表示を更新
                    welcomeMessage.textContent = `${escapeHTML(userData.nickname) || escapeHTML(user.email)} 様、ようこそ。`; // ヘッダーも更新

                    // 1秒後に表示モードに戻る
                    setTimeout(() => {
                        viewMode.style.display = 'block';
                        editMode.style.display = 'none';
                    }, 1000);

                } catch (error) {
                    console.error("プロフィール更新失敗:", error);
                    messageEl.textContent = '保存に失敗しました。';
                    messageEl.className = 'text-sm text-red-400 text-center';
                }
            });
        }
        
        // ▼▼▼▼▼▼▼▼▼▼ 新機能：現メンバー一覧 ▼▼▼▼▼▼▼▼▼▼
        
        /**
         * 全メンバーの一覧（ニックネームと参加日）を読み込む
         */
        function loadAllMembers() {
            const listRef = ref(db, 'user_roles');
            const listContainer = document.getElementById('member-list-container');
            const loadingMessage = document.getElementById('member-list-loading');

            // onValue でリアルタイムに監視
            onValue(listRef, (snapshot) => {
                if (snapshot.exists()) {
                    const allUsers = snapshot.val();
                    loadingMessage.style.display = 'none';
                    listContainer.innerHTML = '';
                    
                    // 配列に変換して、createdAt（参加日）で並び替え
                    const userArray = Object.values(allUsers)
                        .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0)); // 昇順（古い順）
                    
                    userArray.forEach(user => {
                        const displayName = escapeHTML(user.nickname) || escapeHTML(user.email.split('@')[0]) || 'メンバー';
                        
                        let sinceText = '-';
                        if (user.createdAt) {
                            const date = new Date(user.createdAt);
                            sinceText = `MEMBER SINCE: ${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                        }

                        listContainer.innerHTML += `
                            <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-gray-900 border border-gray-700 rounded-lg gap-2">
                                <p class="text-lg text-brand-gold-light">${displayName}</p>
                                <p class="text-sm text-gray-500 flex-shrink-0">${sinceText}</p>
                            </div>
                        `;
                    });
                } else {
                    loadingMessage.textContent = 'メンバーが見つかりません。';
                }
            }, (error) => {
                console.error("メンバー一覧の読み込み失敗:", error);
                loadingMessage.textContent = 'メンバー一覧の読み込みに失敗しました。';
            });
        }


        // --- 既存の関数 ---

        /**
         * メンバー専用お知らせを読み込む
         */
        function loadMemberAnnouncements() {
            const announcementsRef = ref(db, 'member_announcements');
            const listContainer = document.getElementById('announcements-list');
            const loadingMessage = document.getElementById('announcements-loading');
            
            // createdAt（作成日時）で並び替えて、最新のものを取得するクエリ
            const announcementsQuery = query(announcementsRef, orderByChild('createdAt'));

            // onValue を使って、データベースの変更をリアルタイムで監視します
            onValue(announcementsQuery, (snapshot) => {
                if (snapshot.exists()) {
                    const announcements = snapshot.val();
                    
                    if(loadingMessage) loadingMessage.style.display = 'none';
                    listContainer.innerHTML = '';
                    
                    // データベースから取得したデータを配列に変換し、「新しい順」に並び替える
                    const announcementsArray = Object.entries(announcements)
                        .map(([key, value]) => ({ key, ...value })) 
                        .sort((a, b) => b.createdAt - a.createdAt); // 降順（新しい順）
                    
                    announcementsArray.forEach(post => {
                        const date = new Date(post.createdAt);
                        const formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;

                        const article = document.createElement('article');
                        article.className = 'border-b border-gray-800 pb-6';
                        
                        article.innerHTML = `
                            <header class="mb-2">
                                <time class="text-sm text-gray-500">${formattedDate}</time>
                            </header>
                            <h3 class="text-lg font-serif-jp text-gray-200">
                                ${escapeHTML(post.title)}
                            </h3>
                            <div class="text-gray-300 whitespace-pre-wrap mt-2 text-sm leading-relaxed">
                                ${escapeHTML(post.content)}
                            </div>
                        `;
                        
                        listContainer.appendChild(article);
                    });

                } else {
                    if(loadingMessage) loadingMessage.textContent = '現在、お知らせはありません。';
                }
            }, (error) => {
                console.error("お知らせの読み込み失敗:", error);
                if(loadingMessage) loadingMessage.textContent = 'お知らせの読み込みに失敗しました。';
                if (error.code === "PERMISSION_DENIED") {
                    if(loadingMessage) loadingMessage.textContent = 'お知らせの読み取り権限がありません。';
                }
            });
        }

        /**
         * ログアウトボタンをセットアップする
         */
        function setupLogoutButton() {
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async (event) => {
                    event.preventDefault(); // リンクのデフォルト動作（#）をキャンセル
                    try {
                        await signOut(auth);
                        console.log("ログアウトしました。");
                        // ログインページにリダイレクト
                        const repoPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                        window.location.href = window.location.origin + repoPath + '/login.html';
                    } catch (error) {
                        console.error("ログアウト失敗:", error);
                    }
                });
            }
        }
        
    </script>

</body>
</html>
