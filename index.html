<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubTake - ホーム</title>
    <!-- Tailwind CSS を読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts（明朝体とサンセリフ体）を読み込みます -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- CSSファイルを読み込みます -->
    <!-- この環境では外部CSSは読み込まれないため、Tailwindのカスタム設定をHTML内に維持します -->
    
    <style>
        /* ClubTakeの基本スタイル (黒とゴールド) */
        body { background-color: black; color: #E5E7EB; font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.show { 
            display: block; 
            /* モーダルが開いたときに画面上部からフェードインさせる */
            animation: fadeIn 0.3s ease-out;
        }
        .hero-section {
            /* ヒーロー画像はそのまま維持 */
            background-image: url('images/富士山.jpg'); 
            background-size: cover;
            background-position: center;
            /* 画面の高さいっぱいに表示するために h-screen を維持し、min-h を削除 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        // Tailwind CSSのカスタム設定
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'serif-jp': ['"Noto Serif JP"', 'serif']
                    },
                    colors: {
                        // ワイヤーフレームで指定したアクセント色（ゴールド）
                        'brand-gold': '#C0A16B',
                        'brand-gold-light': '#DBC18B', // 少し明るく
                        'brand-gold-dark': '#A0814B'  // 少し暗く
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-black text-gray-200 font-sans">
    <header class="sticky top-0 z-50 w-full bg-black bg-opacity-80 backdrop-blur-sm shadow-lg border-b border-gray-800">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- ロゴ -->
            <div class="text-2xl font-serif-jp font-bold">
                <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                    ClubTake
                </span>
            </div>
            <!-- ナビゲーション（PC用） -->
            <div class="flex space-x-4 md:space-x-8 text-sm tracking-wide">
                <a href="index.html" class="text-white hover:text-brand-gold transition-colors duration-300">Home</a>
                <a href="login.html" class="text-gray-300 hover:text-brand-gold transition-colors duration-300">Members</a>
                <a href="feedback.html" class="text-gray-300 hover:text-brand-gold transition-colors duration-300">Feedback</a>
                <!-- ▼▼▼▼▼▼▼▼▼▼ 追加: 管理者リンク ▼▼▼▼▼▼▼▼▼▼ -->
                <a href="admin.html" id="admin-link" class="hidden text-green-400 hover:text-green-200 transition-colors duration-300">Admin</a>
                <!-- ▲▲▲▲▲▲▲▲▲▲ 追加 ▲▲▲▲▲▲▲▲▲▲ -->
            </div>
        </nav>
    </header>

    <!-- メインコンテンツ -->
    <main>

        <!-- 1. トップページ: セクション1 (ファーストビュー) -->
        <section class="h-screen min-h-[700px] relative flex items-center justify-center text-center text-white overflow-hidden">
            
            <!-- ▼▼▼▼▼▼▼▼▼▼ 背景画像を維持 ▼▼▼▼▼▼▼▼▼▼ -->
            <!-- 背景画像（style="..." のURLを、あなたがアップロードした「富士山.jpg」のパスに変更しました） -->
            <div class="absolute inset-0 bg-cover bg-center z-0" 
                 style="background-image: url('images/富士山.jpg');">
            </div>
            <!-- ▲▲▲▲▲▲▲▲▲▲ 背景画像を維持 ▲▲▲▲▲▲▲▲▲▲ -->
            
            <!-- 背景のオーバーレイ（黒い透かし） -->
            <div class="absolute inset-0 bg-black opacity-60 z-10"></div>
            
            <!-- 中央配置テキストとボタン -->
            <div class="relative z-20 p-8 space-y-4">
                <h1 class="text-4xl md:text-6xl font-serif-jp font-bold hero-text-1" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                    ようこそ、ClubTakeへ。
                </h1>
                <p class="text-xl md:text-3xl font-serif-jp hero-text-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
                    理知が交差し、中立性が守られる場所。
                </p>
                <!-- ▼▼▼▼▼▼▼▼▼▼ 追加: コミュニティ参加ボタン ▼▼▼▼▼▼▼▼▼▼ -->
                <button id="main-join-button" class="mt-8 bg-brand-gold hover:bg-brand-gold-light text-black font-bold py-3 px-8 rounded-lg shadow-lg transition duration-300">
                    コミュニティに参加する
                </button>
                <!-- ▲▲▲▲▲▲▲▲▲▲ 追加 ▲▲▲▲▲▲▲▲▲▲ -->
            </div>
        </section>

        <!-- ▼▼▼▼▼▼▼▼▼▼ 追加: 参加申請モーダル ▼▼▼▼▼▼▼▼▼▼ -->
        <div id="joinModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50">
            <div class="relative top-1/4 mx-auto p-8 border border-gray-700 w-full max-w-md shadow-2xl rounded-lg bg-black transform -translate-y-1/2 md:translate-y-0">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-serif-jp text-brand-gold">コミュニティに参加申請</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-white text-3xl">&times;</button>
                </div>
                <form id="joinForm" class="space-y-4">
                    <div>
                        <label for="joinName" class="block text-sm font-medium text-gray-300">お名前 (ニックネーム可)</label>
                        <input type="text" id="joinName" class="mt-1 w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white" required>
                    </div>
                    <div>
                        <label for="joinEmail" class="block text-sm font-medium text-gray-300">メールアドレス</label>
                        <input type="email" id="joinEmail" class="mt-1 w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white" required>
                    </div>
                    <p id="joinMessage" class="text-sm text-red-400 pt-2"></p>
                    <button type="submit" id="submitJoinRequest" class="w-full justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-black bg-brand-gold hover:bg-brand-gold-light transition-all duration-300">
                        申請を送信する
                    </button>
                </form>
            </div>
        </div>
        <!-- ▲▲▲▲▲▲▲▲▲▲ 追加 ▲▲▲▲▲▲▲▲▲▲ -->

        <!-- 1. トップページ: セクション2 (ご挨拶) -->
        <section class="py-20 md:py-32 bg-black fade-in">
            <div class="container mx-auto px-6">
                <div class="max-w-3xl mx-auto text-center md:text-left">
                    <h2 class="text-3xl md:text-4xl font-serif-jp mb-6">
                        <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                            叡信の原則
                        </span>
                    </h2>
                    <p class="text-base leading-relaxed text-gray-300">
                        CLUB Takeは、高度な専門知識を持つ人々が、社会的な立場を超えて集う場所です。<br>
                        当クラブへの入会は過去の実績ではなく、「クラブのルールを尊重し、真のプロフェッショナルとして行動する」という決意によってのみ決まります。<br>
                        ここでは、あらゆる敵対行為が禁じられ、絶対的な中立性が保障されます。外部の混乱から隔離されたこの空間で、信頼できる情報交換と協力のひとときをお過ごしください。<br>
                    </p>
                </div>
            </div>
        </section>

        <!-- 1. トップページ: セクション3 (クラブの特徴) -->
        <section class="py-20 md:py-32 bg-black fade-in">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-serif-jp text-center mb-16">
                    <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                        ClubTakeの神髄
                    </span>
                </h2>
                <div class="grid md:grid-cols-3 gap-10">
                    <!-- 特徴カード 1: 空間 -->
                    <div class="bg-black border border-gray-800 rounded-lg shadow-xl overflow-hidden group transition-all duration-300 hover:shadow-2xl hover:-translate-y-2">
                        <div class="p-8">
                            <h3 class="text-2xl font-serif-jp mb-3">
                                <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                                    洗練された静謐
                                </span>
                            </h3>
                            <p class="text-sm text-gray-300 leading-relaxed">
                                外部の混乱から隔離された、絶対的な中立空間。ここでは、ただ知的な交流だけが許されます。<br>
                            </p>
                        </div>
                    </div>
                    <!-- 特徴カード 2: サービス -->
                    <div class="bg-black border border-gray-800 rounded-lg shadow-xl overflow-hidden group transition-all duration-300 hover:shadow-2xl hover:-translate-y-2">
                        <div class="p-8">
                            <h3 class="text-2xl font-serif-jp mb-3">
                                <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                                    絶対的中立性
                                </span>
                            </h3>
                            <p class="text-sm text-gray-300 leading-relaxed">
                                利害が対立する組織のメンバーであっても、ここでは互いへの敬意と中立を維持することが求められます。<br>
                            </p>
                        </div>
                    </div>
                    <!-- 特徴カード 3: 伝統 -->
                    <div class="bg-black border border-gray-800 rounded-lg shadow-xl overflow-hidden group transition-all duration-300 hover:shadow-2xl hover:-translate-y-2">
                        <div class="p-8">
                            <h3 class="text-2xl font-serif-jp mb-3">
                                <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                                    独立の誓い
                                </span>
                            </h3>
                            <p class="text-sm text-gray-300 leading-relaxed">
                                2025年7月9日。私たちは社会的な因縁を脇に置き、クラブの「叡信」の原則にのみ従うことを誓いました。<br>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 1. トップページ: セクション5 (お知らせ) -->
        <section id="news-section" class="py-20 md:py-32 bg-black fade-in">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-serif-jp text-center mb-16">
                    <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                        お知らせ
                    </span>
                </h2>
                
                <!-- 読み込み中メッセージ -->
                <div id="news-loading-message" class="text-center text-gray-400">
                    お知らせを読み込んでいます...
                </div>
                
                <!-- お知らせ一覧が挿入されるコンテナ -->
                <div id="news-list-container" class="max-w-3xl mx-auto space-y-6">
                    <!-- ここにJavaScriptによってお知らせが挿入されます -->
                </div>
            </div>
        </section>

    </main>

    <!-- 共通フッター -->
    <footer class="py-16 bg-black border-t border-gray-800">
        <div class="container mx-auto px-6 text-center text-gray-400">
            <!-- ロゴ -->
            <div class="text-2xl font-serif-jp font-bold mb-4">
                <span class="bg-gradient-to-b from-brand-gold-light via-brand-gold to-brand-gold-dark bg-clip-text text-transparent drop-shadow-[0_2px_8px_rgba(192,161,107,0.4)]">
                    ClubTake
                </span>
            </div>
            <!-- 住所など -->
            <p class="text-sm">〒XXX-XXXX 東京都千代田区丸の内X-X-X</p>
            <p class="text-sm">TEL: 03-XXXX-XXXX</p>
            <!-- フッターナビ -->
            <div class="flex justify-center space-x-6 my-6 text-sm">
                <a href="#" class="hover:text-brand-gold transition-colors duration-300">サイトマップ</a>
                <a href="#" class="hover:text-brand-gold transition-colors duration-300">プライバシーポリシー</a>
            </div>
            <!-- コピーライト -->
            <p class="text-xs text-gray-500 mt-8">
                &copy; 2025 ClubTake. All Rights Reserved.
            </p>
        </div>
    </footer>

    <!-- アニメーションのコードを外部ファイル(js/main.js)から読み込みます -->
    <script src="js/main.js" defer></script>

    <!-- Firebase読み込みスクリプト -->
    <script type="module">
        // Firebaseの基本的な機能（App）を読み込みます
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Realtime Database の機能を読み込みます
        import { getDatabase, ref, query, orderByChild, limitToLast, onValue, set, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        // 認証機能を追加
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // あなたの「本物の」設定情報を貼り付けます
        const firebaseConfig = {
          apiKey: "AIzaSyDgpAbNmhRGgxiJusSqo1mG1wJbX4TS0uI",
          authDomain: "clubtake-257af.firebaseapp.com",
          projectId: "clubtake-257af",
          storageBucket: "clubtake-257af.firebasestorage.app",
          messagingSenderId: "871043706318",
          appId: "1:871043706318:web:19e8cfb02823003e518f9f",
          measurementId: "G-NVXMV89KHP"
        };
        
        // Realtime Database の URL を config に追加します
        firebaseConfig.databaseURL = "https://clubtake-257af-default-rtdb.firebaseio.com/";

        let app, db, auth, userId; // Auth を追加
        let isMember = false;
        let isAdmin = false;

        const listContainer = document.getElementById('news-list-container');
        const loadingMessage = document.getElementById('news-loading-message');
        
        // ▼▼▼▼▼▼▼▼▼▼ UI要素の取得（新規追加） ▼▼▼▼▼▼▼▼▼▼
        const joinButton = document.getElementById('main-join-button');
        const joinModal = document.getElementById('joinModal');
        const closeModal = document.getElementById('closeModal');
        const joinForm = document.getElementById('joinForm');
        const joinMessage = document.getElementById('joinMessage');
        const adminLink = document.getElementById('admin-link');
        // ▲▲▲▲▲▲▲▲▲▲ UI要素の取得（新規追加） ▲▲▲▲▲▲▲▲▲▲

        try {
            // Firebaseを初期化します
            app = initializeApp(firebaseConfig);
            // Realtime Database を初期化します
            db = getDatabase(app);
            // Auth を初期化します
            auth = getAuth(app);
            
            // お知らせの読み込みを開始します
            loadPublicNews();
            
            // 認証とUIリスナーのセットアップを開始
            setupAuthAndListeners();

        } catch (error) {
            console.error("Firebase initialization error:", error);
            if(loadingMessage) loadingMessage.textContent = "システムの初期化に失敗しました。";
        }

        // ▼▼▼▼▼▼▼▼▼▼ 認証とリスナーの設定関数（新規追加） ▼▼▼▼▼▼▼▼▼▼
        async function setupAuthAndListeners() {
            setupAuthListener();
            setupUIListeners();
        }

        async function checkAndSignIn() {
            try {
                // 匿名サインインを試みる
                await signInAnonymously(auth);
            } catch (error) {
                console.error("サインインエラー:", error);
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // 匿名ユーザーの場合は DB アクセスをスキップ
                    if (user.isAnonymous) {
                         joinButton.textContent = "コミュニティに参加する";
                         joinButton.disabled = false;
                         joinButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        // 認証済みユーザーの場合のみ、役割と申請状況をチェック
                        await checkUserRole(userId);
                    }
                } else {
                    // ログアウト状態の場合、匿名でサインインを試みる
                    checkAndSignIn();
                }
            });
        }
        
        async function checkUserRole(uid) {
            try {
                const roleRef = ref(db, `user_roles/${uid}`);
                const snapshot = await get(roleRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    isMember = true; // DBに存在する=メンバーと見なす
                    isAdmin = userData.isAdmin === true;
                    
                    if (isAdmin) {
                        adminLink.classList.remove('hidden');
                    }
                    // メンバーであれば、ボタンを「ログイン済み」状態に変更 
                    joinButton.textContent = "メンバーとしてログイン済み";
                    joinButton.disabled = true;
                    joinButton.classList.add('opacity-50', 'cursor-not-allowed');
                    
                } else {
                    isMember = false;
                    checkPendingRequest(uid);
                }
            } catch (error) {
                console.error("ユーザー役割チェックエラー:", error);
            }
        }

        async function checkPendingRequest(uid) {
            // 認証済みユーザー（匿名ではない）の申請状況をチェック
            try {
                // パス名は admin.html と同じ 'pending_users' に統一
                const pendingRef = ref(db, `pending_users/${uid}`);
                const snapshot = await get(pendingRef);

                if (snapshot.exists()) {
                    // 申請済み
                    joinButton.textContent = "参加申請済み (承認待ち)";
                    joinButton.disabled = true;
                    joinButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    // 未申請
                    joinButton.textContent = "コミュニティに参加する";
                    joinButton.disabled = false;
                    joinButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                // 認証済みユーザーでエラーが出る場合、DBルールが原因なので、その旨を表示
                console.error("申請状況チェックエラー:", error);
                
                if (error.code && error.code.includes('PERMISSION_DENIED')) {
                    joinButton.textContent = "申請状況の確認に失敗（DBルールエラー）";
                    joinButton.disabled = true;
                    joinButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    joinButton.textContent = "エラーが発生しました";
                    joinButton.disabled = true;
                }
            }
        }
        
        function setupUIListeners() {
            // モーダルを閉じる
            closeModal.addEventListener('click', () => {
                joinModal.classList.remove('show');
                joinMessage.textContent = '';
            });

            // joinButton のリスナーを setupAuthListener の外に移動し、常に有効にする
            // ただし、ボタンが disabled でない場合のみモーダルを開く
            joinButton.addEventListener('click', () => {
                if (!joinButton.disabled) {
                    joinModal.classList.add('show');
                    joinMessage.textContent = '';
                }
            });

            // 参加申請フォーム
            joinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // 匿名ユーザーでも申請は可能
                if (!userId) {
                    joinMessage.textContent = '認証に失敗しました。ページを再読み込みしてください。';
                    return;
                }
                
                const name = document.getElementById('joinName').value;
                const email = document.getElementById('joinEmail').value;
                const submitButton = document.getElementById('submitJoinRequest');
                submitButton.disabled = true;
                submitButton.textContent = '申請中...';

                try {
                    // Realtime Database に申請データを書き込む (pending_users)
                    const requestRef = ref(db, `pending_users/${userId}`); 
                    await set(requestRef, {
                        email: email,
                        name: name,
                        createdAt: serverTimestamp(),
                        status: 'pending' // pending_usersのvalidateルールに合わせる
                    });

                    joinModal.classList.remove('show');
                    joinForm.reset();
                    
                    // 申請ボタンの状態を更新 (DBチェックに頼らず、成功したらすぐにUIを更新する)
                    joinButton.textContent = "参加申請済み (承認待ち)";
                    joinButton.disabled = true;
                    joinButton.classList.add('opacity-50', 'cursor-not-allowed');

                } catch (error) {
                    console.error("参加申請エラー:", error);
                    joinMessage.textContent = `申請に失敗しました: ${error.message}`;
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = '申請を送信する';
                }
            });
        }
        // ▲▲▲▲▲▲▲▲▲▲ 認証とリスナーの設定関数（新規追加） ▲▲▲▲▲▲▲▲▲▲
        

        /**
         * 一般公開用お知らせを読み込んで表示する関数 (既存のロジックを維持)
         */
        function loadPublicNews() {
            const newsRef = ref(db, 'public_news');
            
            // createdAt（作成日時）で並び替え、最新の3件を取得するクエリ
            const newsQuery = query(newsRef, orderByChild('createdAt'), limitToLast(3));

            // onValue を使って、データベースの変更をリアルタイムで監視します
            onValue(newsQuery, (snapshot) => {
                if (snapshot.exists()) {
                    const news = snapshot.val();
                    
                    if(loadingMessage) loadingMessage.style.display = 'none';
                    listContainer.innerHTML = '';
                    
                    const newsArray = Object.entries(news)
                        .map(([key, value]) => ({ key, ...value })) 
                        .sort((a, b) => b.createdAt - a.createdAt); 
                    
                    
                    newsArray.forEach(post => {
                        
                        const date = new Date(post.createdAt);
                        const formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                        
                        const escapeHTML = (str) => {
                             if (typeof str !== 'string') return '';
                             return str.replace(/[&<>"']/g, (match) => {
                                return {
                                  '&': '&amp;',
                                  '<': '&lt;',
                                  '>': '&gt;',
                                  '"': '&quot;',
                                  "'": '&#39;'
                                }[match];
                            });
                        }
                        
                        const categoryClass = post.category === '催事' ? 'text-brand-gold-light' : 'text-gray-400';

                        const newsItem = document.createElement('a');
                        
                        newsItem.href = `news-detail.html?id=${escapeHTML(post.key)}`; 
                        
                        newsItem.className = "block p-6 bg-black border border-gray-800 rounded-lg shadow-lg hover:bg-gray-900 transition-all duration-300 group";
                        
                        newsItem.innerHTML = `
                            <p class="text-sm text-gray-500 mb-1">
                                <time>${formattedDate}</time> | <span class="font-medium ${categoryClass}">${escapeHTML(post.category)}</span>
                            </p>
                            <h3 class="text-lg font-serif-jp text-gray-200 group-hover:text-brand-gold-light transition-colors duration-300">
                                ${escapeHTML(post.title)}
                            </h3>
                        `;
                        
                        listContainer.appendChild(newsItem);
                    });

                } else {
                    if(loadingMessage) loadingMessage.textContent = '現在、お知らせはありません。';
                }
            }, (error) => {
                console.error("お知らせの読み込み失敗:", error);
                if(loadingMessage) loadingMessage.textContent = 'お知らせの読み込みに失敗しました。';
            });
        }
    </script>

</body>
</html>
